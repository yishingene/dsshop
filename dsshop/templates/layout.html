{% extends "base.html" %}
{% load staticfiles promotion_tags%}

{% block styles %}
    {% comment %}
        If you are developing Oscar's CSS, or overriding Oscar's CSS
        files in your project, then set USE_LESS = True in your
        settings file. This will enable the on-the-fly less compiler.
    {% endcomment %}
    {% if use_less %}
        <link rel="stylesheet/less" type="text/css" href="{% static 'oscar/less/styles.less' %}" />
    {% else %}
        <link rel="stylesheet" type="text/css" href="{% static 'oscar/css/styles.css' %}" />
    {% endif %}
    <link rel="stylesheet" href="{% static 'oscar/js/bootstrap-datetimepicker/bootstrap-datetimepicker.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'oscar/css/datetimepicker.css' %}" />
    <!-- CANAVA TEMPLATE CSS-->
    <link rel="stylesheet" type="text/css" href="{% static 'css/canava.css' %}">
    <!-- CANAVA: Responsive -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/responsive.css' %}">

    <!-- CUSTOM STYLES -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/custom.css' %}">
{% endblock %}

{% block layout %}
    {# Top-horizontal bar with account, notifictions, dashboard links #}
    {# include "partials/nav_accounts.html" #}

    <div class="boxed">
        {% include 'partials/header.html' %}
        {% block subheader_title %}
            {% include 'partials/page-title.html' with page_title=page_title %}
        {% endblock subheader_title  %}
        {% block breadcrumbs %}
        {% endblock breadcrumbs %}
        {% block product_list %}
        {% endblock product_list %}
        
        <!-- Footer -->
        <footer class="footer">
            {% include 'partials/footer.html' %}
        </footer>
    </div>
{% endblock %}

{% block cdn_scripts %}
  {{ block.super }}
  {% if use_less and debug %}
    {# Load the on-the-fly less compiler. Never do this in production. #}
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.3/less.min.js"></script>
  {% endif %}
{% endblock %}

{# Local scripts #}
{% block scripts %}
    {{ block.super }}
    <!-- Twitter Bootstrap -->
    <script type="text/javascript" src="{% static 'oscar/js/bootstrap3/bootstrap.min.js' %}"></script>
    <!-- CANAVA: parallax title -->
    <script type="text/javascript" src="{% static 'js/parallax.js' %}"></script>
    <!-- Oscar -->
    <script src="{% static 'oscar/js/oscar/ui.js' %}" type="text/javascript" charset="utf-8"></script>

    <script src="{% static 'oscar/js/bootstrap-datetimepicker/bootstrap-datetimepicker.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'oscar/js/bootstrap-datetimepicker/locales/bootstrap-datetimepicker.all.js' %}" type="text/javascript" charset="utf-8"></script>
    <!-- REAL PYTHON SCRIPT: For django CSRF token -->
    <script type="text/javascript" src="{% static 'plugins/realpython/csrf_protection.js' %}"></script>

{% endblock %}

{% block extrascripts %}
    {% include "partials/extrascripts.html" %}
    {{ block.super }}
    <script type="text/javascript">

        var responsiveMenu = function() {
            var menuType = 'desktop';

            $(window).on('load resize', function() {
                var currMenuType = 'desktop';
                if ( matchMedia( 'only screen and (max-width: 991px)' ).matches ) {
                    currMenuType = 'mobile';
                }

                if ( currMenuType !== menuType ) {
                    menuType = currMenuType;

                    if ( currMenuType === 'mobile' ) {
                        var $mobileMenu = $('#mainnav').attr('id', 'mainnav-mobi').hide();
                        var hasChildMenu = $('#mainnav-mobi').find('li:has(ul)');

                        $('.mega-menu .mega-menu-sub').hide();
                        $('.has-mega-menu .submenu.mega-menu').hide();

                        $('#header').after($mobileMenu);
                        hasChildMenu.children('ul').hide();
                        hasChildMenu.children('a:not(.has-mega)').after('<span class="btn-submenu"></span>');
                        $('.btn-menu').removeClass('active');
                    } else {
                        var $desktopMenu = $('#mainnav-mobi').attr('id', 'mainnav').removeAttr('style');

                        $desktopMenu.find('.submenu').removeAttr('style');
                        $('#header').find('.nav-wrap').append($desktopMenu);
                        $('.btn-submenu').remove();
                    }
                }
            });

        $('.btn-menu').on('click', function() {         
            $('#mainnav-mobi').slideToggle(300);
            $(this).toggleClass('active');
        });

        // Mega menu click
        if ( matchMedia( 'only screen and (max-width: 991px)' ).matches ) {
            $('.btn-mega').on('click', function() {      
                $(this).parent('.mega-title').siblings().slideToggle(300);   
                $(this).toggleClass('active');
            });

            $('.has-mega').on('click', function() {      
                $(this).siblings().slideToggle(300);  
                $(this).toggleClass('active');
            });
        }        

        $(document).on('click', '#mainnav-mobi li .btn-submenu', function(e) {
            $(this).toggleClass('active').next('ul').slideToggle(300);
            e.stopImmediatePropagation()
        });

    }

        var headerFixed = function() {    
            if ( $('body').hasClass('header-sticky') ) {
                var hd_height = $('#header').height();           
                $(window).on('load scroll', function(){                
                    if ( $(window).scrollTop() >  37 ) {
                        $('#header').addClass('downscrolled');                      
                    } else {                    
                        $('#header').removeClass('downscrolled');                   
                    }
                    if( $(window).scrollTop() > 37 ) {
                        $('#header').addClass('upscrolled');                    
                    } else {
                        $('#header').removeClass('upscrolled');                    
                    }
                })            
            }   
        }
        $(function() { 
            if ( matchMedia( 'only screen and (min-width: 991px)' ).matches ) {
                headerFixed();
            }
            responsiveMenu();
        });
    </script>
    <script type="text/javascript">
        $('a.nav-basket').on('click', function(){
            console.log('remove me');
            console.log($(this).data('update-url'));

            var url = $(this).data('update-url');
            var item = $(this).parent();

            $.ajax({
                url: url,
                type: 'DELETE',
                dataType:'json',
                success: handler,
                error: function(xhr, ajaxOptions, thrownError) {
                    console.log(xhr.status);
                    alert(thrownError);
                }
            });
            function handler(data) {
                // 1. remove item from Mini cart
                item.remove();
                // 2. update total amount
                $.ajax({
                    url: '{% url 'basket-detail' basket.pk %}',
                    tyep: 'GET',
                    dataType: 'json',
                    success: updateTotal,
                    error: function(xhr, ajaxOptions, thrownError) {
                    console.log(xhr.status);
                    alert(thrownError);
                    }
                });

                function updateTotal(data) {
                    console.log(data);
                    var amount = data['total_incl_tax'];

                    if(amount == 0) {
                        $('div.subcart').remove();
                        //$('div.subcart').css('visibility', 'hidden')
                    }
                    else {
                        $('span#mini_cart_amount').text('â‚¬ ' + amount);
                    }
                }
            } 
        });
    </script>
{% endblock %}

{% block onbodyload %}
    {{ block.super }}
    oscar.init();
{% endblock %}

